function getCookie(name) {
    const cookieArr = document.cookie.split(";");
    for (let i = 0; i < cookieArr.length; i++) {
        const cookiePair = cookieArr[i].split("=");
        if (name === cookiePair[0].trim()) {
            return decodeURIComponent(cookiePair[1]);
        }
    }
    return null;
}
function OnDocumentReady(response) {
    let provinceCode = "";

    function setProvinceOptions() {
        $.ajax({
            url: `/address/getprovinces`,
            type: 'GET',
            async: false,
            success: function (response) {
                const data = JSON.parse(response);
                const selected = response.select;
                const selectElement = $('#main-province');
                const selectElementWin = $('#win-province-select');

                provinceCode = getCookie("ProvinceCode");

                if (data) {
                    let html = '<option style="font-weight: bold" value="">Tỉnh/TP sinh sống</option>';
                    data.forEach(item => {
                        html += `<option ${item.Code === provinceCode || item.Code === selected ? 'selected' : ''} value="${item.Code}">${item.Name}</option>`;
                    });
                    selectElement.html(html);
                    selectElementWin.html(html);

                }


                
            }
        });
    }
    setProvinceOptions();

    const selectElementWin = $('#win-province-select');
    selectElementWin.on('change', function () {
        const selectedProvinceCode = $(this).val();
        setDistrictOptions(selectedProvinceCode);

        let defaultOption = '<option style="font-weight: bold" value="">Phường/ Xã</option>';
        element = $(`#win-ward-select`);

        element.html(defaultOption);
        
    });

    const selectElementWinDistrict = $('#win-district-select');
    selectElementWinDistrict.on('change', function () {
        const selectedProvinceCode = selectElementWin.val();
        const selectedDistrictCode = $(this).val();
        setWardOptions(selectedProvinceCode, selectedDistrictCode);
    });

    $('body').on('click', '.confirm-info, .change-info', function () {
        $(".modal, .modal-backdrop").removeClass("show");
        $("body").removeClass("no-scroll");
    });

    const showLoadingModal = (message, animation = 'wave') => {
        $('body').loadingModal({
            text: message,
            position: 'auto',
            color: '#fff',
            opacity: '0.7',
            backgroundColor: 'rgb(0,0,0)',
            animation
        });
    };

    $(".close-popup, .close, .closeRemove").click(function () {
        $(".submit-btn").attr('disabled', false);
        $(".modal, .modal-backdrop").removeClass("show");
        $("body").removeClass("no-scroll");
        $('#confirm-btn').off('click');

        if ($(window).width() <= 1000) {
            $('html, body').animate({
                scrollTop: $("#smform").offset().top
            }, 100);
        }
    });

   
    if (response) {

        if (response.Type === 'GhiNhanThongTin') {
            showNotiModal(response.Message);
        }

        setDistrictOptions(provinceCode);

        switch (response.Status) {
            case 404:
                showNotiModal('Gặp sự cố mạng vui lòng thử lại sau!');
                break;
            case 6:
                showMaKhongHopLe();
                break;
            case 5:
                showMaDaSuDung();
                break;
            case 7:
                showMaDaSuDungCungSDT(response.Prize, response.Message);
                break;
            case 4:
                showKetThucChuongTrinh();
                break;
            case 3:
            case 1:
            case 2:
                showNotiModal(response.Message);
                break;
            case 0:
                if (response.Type === 'winPrize') {
                    $(".submit-btn").attr('disabled', true);
                    showWinModal(response.Prize, response.HtmlGiai);
                } else {
                    $(".submit-btn").attr('disabled', true);
                    if (response.Type === 'notWin') {
                        const ketqua = getRandomFromArray(['2', '4', '6']);
                        rollNow(ketqua);
                    } else {
                        showNotiModal(response.Message);
                    }
                }
                break;
        }
       
    }
  
    const form = $(".form-quay-thuong");
    const submitButton = $(".submit-btn");
    submitButton.click(function () {
        if (form.valid()) {
            submitButton.attr('disabled', true);

            const phoneVal = $("#main-phone").val();
            const codeVal = $("#main-code").val();
            const provinceVal = $("#main-province option:selected").text();

            $("#confirm-phone").text(phoneVal);
            $("#confirm-code").text(codeVal);
            $("#confirm-province").text(provinceVal);

            $(".modal").removeClass("show");
            $("#popup-xac-nhan-quay-thuong").addClass("show");
            $(".modal-backdrop").addClass("show");
            $("body").addClass("no-scroll");

            // Hide the keyboard
            $("#main-phone").blur();
            $("#main-code").blur();
            $("#main-province").blur();

            $('#confirm-btn').one('click', function () {
                $(this).attr('disabled', true);
                setTimeout(() => {
                    $('#confirm-btn').attr('disabled', false);
                }, 1000);

                $(".modal, .modal-backdrop").removeClass("show");
                $("body").removeClass("no-scroll");

                showLoadingModal();

                form.submit();
            });
        }
    });


    const updateInfoButton = $("#update-info-btn");
    const updateInfoForm = $("#update-info-form");
    updateInfoButton.click(function () {
        updateInfoButton.attr('disabled', true);
        setTimeout(() => {
            updateInfoButton.attr('disabled', false);
        }, 1000);

        if (updateInfoForm.valid()) {
            const nameVal = updateInfoForm.find('input[name="WinnerInfo.Name"]').val();
            
            const phoneVal = updateInfoForm.find('input[name="WinnerInfo.Phone"]').val();
            const addressVal = updateInfoForm.find('input[name="WinnerInfo.Address"]').val();
            const districtVal = updateInfoForm.find('select[name="WinnerInfo.District"] option:selected').text();
            const provinceVal = updateInfoForm.find('select[name="WinnerInfo.Province"] option:selected').text();
            const wardVal = updateInfoForm.find('select[name="WinnerInfo.Ward"] option:selected').text();

            $("#win-name").text(nameVal);
            $("#win-district").text(districtVal);
            $("#win-address").text(addressVal);
            $("#win-phone").text(phoneVal);
            $("#win-province").text(provinceVal);
            $("#win-ward").text(wardVal);

            $(".modal").removeClass("show");
            $("#popup-xac-nhan-trung-thuong").addClass("show");
            $(".modal-backdrop").addClass("show");
            $("body").addClass("no-scroll");

            // Hide the keyboard
            $("#win-name").blur();
            $("#win-phone").blur();
            $("#win-province").blur();
            $("#win-district").blur();
            $("#win-ward").blur();
            $("#win-address").blur();
            $("#win-code").blur();

            $("#main-phone").blur();
            $("#main-code").blur();
            $("#main-province").blur();

            updateInfoForm.find('input[name="WinnerInfo.Name"]').blur();
            updateInfoForm.find('input[name="WinnerInfo.Phone"]').blur();
            updateInfoForm.find('input[name="WinnerInfo.Address"]').blur();

            $('#thayDoiThongTin').one('click', function () {
                $(".modal").removeClass("show");
                $("#popup-trung-guong-led").addClass("show");
                $(".modal-backdrop").addClass("show");
                $("body").addClass("no-scroll");
            });

            $('#win-btn').one('click', function () {
                $(this).attr('disabled', true);
                $(".modal, .modal-backdrop").removeClass("show");
                $("body").removeClass("no-scroll");

                showLoadingModal();

                updateInfoForm.submit();
            });
        } else {
            return false;
        }
    });
    function getRandomFromArray(arr) {
        const randomIndex = Math.floor(Math.random() * arr.length);
        return arr[randomIndex];
    }
}
//////////////////

function setDistrictOptions(provinceCode) {
    $.ajax({
        url: `/address/GetDistricts?ProvinceName=${provinceCode}`,
        type: 'GET',
        cache: false,
        success: function (response) {
            const data = JSON.parse(response);
            if (data) {
                let html = '<option style="font-weight: bold" value="">Quận/ Huyện</option>';
                data.forEach(item => {
                    html += `<option value="${item.Code}">${item.Name}</option>`;
                });
                $('.district-select').html(html);
            }
        }
    });
} function setWardOptions(provinceCode,districtCode ) {
    $.ajax({
        url: `/address/GetWards?ProvinceName=${provinceCode}&DistrictName=${districtCode}`,
        type: 'GET',
        cache: false,
        success: function (response) {
            const data = JSON.parse(response);
            if (data) {
                let html = '<option style="font-weight: bold" value="">Phường/ Xã</option>';
                data.forEach(item => {
                    html += `<option value="${item.Code}">${item.Name}</option>`;
                });
                $('.ward-select').html(html);
            }
        }
    });
}


// lấy kết quả trả về
const showWinModal = (prize, htmlGiai) => {
    $(".modal").removeClass("show");
    if (prize === '3') {
        document.getElementById('z3').innerHTML = htmlGiai;
        rollNow('1');
    } else if (prize === '2') {

        document.getElementById('z2').innerHTML = htmlGiai;
        document.getElementById('title_z2').innerHTML = "Thông tin nhận quà";
        $("#btn_z2").removeAttr("hidden");

        rollNow('5');
    } else {
        const ketqua = getRandomFromArray(['2', '4', '6']);
        rollNow(ketqua);
    }
    return false;
};

const showKetThucChuongTrinh = () => {
    $('#popup-ct-ket-thuc').addClass('show');
    $(".modal-backdrop").addClass("show");
    $("body").addClass("no-scroll");
    return false;
};

const showChuongTrinhChuaBatDau = () => {
    $('.popup-ma-khong-hop-le').addClass('show');
    $(".modal-backdrop").addClass("show");
    $("body").addClass("no-scroll");
    return false;
};

const showMaKhongHopLe = () => {
    $('#popup-rat-tiec-ma-khong-hop-le').addClass('show');
    $(".modal-backdrop").addClass("show");
    $("body").addClass("no-scroll");
    return false;
};

const showMaDaSuDung = () => {
    $('#popup-rat-tiec-ma-da-su-dung').addClass('show');
    $(".modal-backdrop").addClass("show");
    $("body").addClass("no-scroll");
    return false;
};

const showMaDaSuDungCungSDT = (prize, date) => {
    $('#popup-ma-da-su-dung').addClass('show');
    $('.ten-giai').html(prize);
    if (prize !== "Không trúng giải") {
        $('.ten-giai').removeClass("text-red");
    }
    $('.ngay-trung-giai').html(date);
    $(".modal-backdrop").addClass("show");
    $("body").addClass("no-scroll");
    return false;
};

const showNotiModal = (message) => {
    $('.text-noti').html(message);
    $("#popup-thong-bao").addClass("show");
    $(".modal-backdrop").addClass("show");
    $("body").addClass("no-scroll");
};
